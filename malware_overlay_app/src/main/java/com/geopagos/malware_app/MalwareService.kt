package com.geopagos.malware_app

import android.app.Service
import android.content.Context
import android.content.Intent
import android.graphics.Color.GREEN
import android.graphics.PixelFormat
import android.os.IBinder
import android.view.Gravity
import android.view.ViewGroup.LayoutParams.WRAP_CONTENT
import android.view.WindowManager
import android.widget.Button
import android.widget.LinearLayout
import android.widget.TextView

class MalwareService : Service() {

    private val windowManager by lazy { getSystemService(Context.WINDOW_SERVICE) as WindowManager }

    private val view  by lazy {
        LinearLayout(this).apply {
            var counter = 0

            val textView = TextView(this@MalwareService).apply {
                text = "Malware overlay"
            }

            val counterView =  TextView(this@MalwareService).apply {
                gravity = Gravity.CENTER
                text = "$counter"
            }

            val button = Button(this@MalwareService).apply {
                text = "Click"
                setOnClickListener {
                    counterView.text = "${++counter}"
                }
            }

            orientation = LinearLayout.VERTICAL
            setBackgroundColor(GREEN)
            addView( textView )
            addView( counterView )
            addView( button )

            layoutParams = LinearLayout.LayoutParams(WRAP_CONTENT, WRAP_CONTENT)
        }
    }

    override fun onBind(p0: Intent?): IBinder? {
        return null
    }

    override fun onCreate() {
        super.onCreate()
        initOverlay()
    }

    override fun onDestroy() {
        super.onDestroy()
        windowManager.removeView(view)
    }

    private fun initOverlay() {
        val params = WindowManager.LayoutParams(
            WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
            /*WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE or */WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
            PixelFormat.TRANSLUCENT
        )
        params.height = WRAP_CONTENT
        params.width = WRAP_CONTENT

        windowManager.addView(view, params)
    }
}